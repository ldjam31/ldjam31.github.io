// (c) 2014 - hugo.kelfani@gmail.com
var Cassava={Timer:function(){this.elapsed=0,this.last=null,this.tick=function(a){this.elapsed=(a-this.last)/1e3,this.last=a},this.fps=function(){return Math.round(1/this.elapsed)}},clone:function(a){var b,c,d,e;if(null===a||"object"!=typeof a)return a;if(a instanceof Date)return c=new Date,c.setTime(a.getTime()),c;if(a instanceof Array){for(c=[],d=0;d<a.length;++d)e=a[d],c[d]=this.clone(a[d]);return c}if(a instanceof Object){c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=this.clone(a[b]));return c}throw new Error("Unable to copy ! Its type isn't supported.")},_id:0,getId:function(){return Cassava._id++},_keysPushed:{},isPushed:function(a){return!!Cassava._keysPushed[a]},Color:{BLACK:"#000000",WHITE:"#FFFFFF",RED:"#FF0000",GREEN:"#00FF00",BLUE:"#0000FF"},fixedFloat:function(a){return Math.round(100*a)/100},isMobile:function(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/iPhone|iPad|iPod/i)||navigator.userAgent.match(/Opera Mini/i)||navigator.userAgent.match(/IEMobile/i)}};window.addEventListener("keydown",function(a){Cassava._keysPushed[a.keyCode]=!0}),window.addEventListener("keyup",function(a){Cassava._keysPushed[a.keyCode]=!1}),!function(){Cassava.LinkedList=function(a){this.factory=a,this.firstNode=null,this.lastNode=null,this.map=null,this.pool=Cassava.LinkedList.LinkedNodePool,this.init()},Cassava.LinkedList.prototype={init:function(){return this.map={},this},free:function(){this.clear(),this.factory.free(this)},push:function(b){var c=a(this,b);if(void 0!==this.map[b.id])throw new Error("An object with id "+b.id+" has already been pushed in this list.");return null===this.firstNode?this.firstNode=this.lastNode=c:(this.lastNode.push(c),this.lastNode=c),this.map[b.id]=c,this},pushWhen:function(b,c){var d=a(this,b);if(void 0!==this.map[b.id])throw new Error("An object with id "+b.id+" has already been pushed in this list.");return null===this.firstNode?this.firstNode=this.lastNode=d:this.firstNode.pushWhen(d,c),this.map[b.id]=d,this},pop:function(){if(this.isEmpty())return null;var a=this.firstNode.o;return this.remove(a),a},has:function(a){return null!==this.firstNode?void 0!==this.map[a.id]:!1},freeNode:function(a){return a===this.firstNode&&(this.firstNode=a.next),a===this.lastNode&&(this.lastNode=a.pred),this.map[a.o.id]=void 0,this.pool.push(a),a.o},remove:function(a){void 0!==this.map[a.id]&&(this.map[a.id].remove(a.id),this.map[a.id]=void 0)},log:function(){return this.map},clear:function(){for(var a=this.firstNode;null!==a;)this.freeNode(a),a=a.next;return this.firstNode=null,this.lastNode=null,this},get:function(a){return null!==this.map[a]&&void 0!==this.map[a]?this.map[a].o:null},isEmpty:function(){return null===this.firstNode}},Cassava.LinkedList.LinkedNodePool=[];var a=Cassava.LinkedList.GetNewLinkedNode=function(a,b){return 0===Cassava.LinkedList.LinkedNodePool.length?new Cassava.LinkedNode(b,a):Cassava.LinkedList.LinkedNodePool.pop().reset(b,a)}}(),Cassava.LinkedList.Factory=function(){this._pool=[]},Cassava.LinkedList.Factory.prototype={create:function(){return 0===this._pool.length?new Cassava.LinkedList(this):this._pool.pop().init()},free:function(a){this._pool.push(a)}},Cassava.LinkedNode=function(a,b){this.o=a,this.next=null,this.pred=null,this.linkedList=b},Cassava.LinkedNode.prototype={reset:function(a,b){return this.o=a,this.linkedList=b,this.pred=null,this.next=null,this},push:function(a){null===this.next?(this.next=a,a.pred=this):this.next.push(a)},pushWhen:function(a,b){b(a.o,this.o)?(a.next=this,a.pred=this.pred,this.pred=a,a.pred?a.pred.next=a:this.linkedList.firstNode=a):null!==this.next?this.next.pushWhen(a,b):(this.next=a,a.pred=this,a.next=null)},remove:function(a){this.o.id===a?(this.linkedList.freeNode(this),null!==this.pred&&(this.pred.next=this.next),null!==this.next&&(this.next.pred=this.pred)):null!==this.next&&this.next.remove(a)},has:function(a){return this.o.id===a?!0:null!==this.next?this.next.has(a):!1},log:function(a){a.push(this.o),null!==this.next&&this.next.log(a)},clear:function(){null!==this.next&&this.next.clear(),this.linkedList.freeNode(this)},get:function(a){return this.o.id===a?this.o:null!==this.next?this.next.get(a):null}},Cassava.Game=function(a,b,c,d,e){this.name=a,this.renderer=b,this.width=c,this.height=d,this._color=Cassava.Color.BLACK,this.scale=e||1,this._canvas=null,this._context=null,this._cachedCanvas=null,this._cachedCanvasContext=null,this._initCanvas(),this._currentScreen=null,this._waitingScreen=!1,this._waitingScreenName=null,this._waitingScreenDatas=null,this._assetsLoaded=!0,this._isRunning=!1,this.state=null,this.LinkedList=new Cassava.LinkedList.Factory,this.Entity=new Cassava.Manager(this,Cassava.Entity.Factory),this.Entity.define("entity_default"),this.Event=new Cassava.Manager(this,Cassava.Event.Factory),this.Module=new Cassava.Manager(this,Cassava.Module.Factory),this.Sprite=new Cassava.Manager(this,Cassava.Sprite.Factory),this.Grid=new Cassava.Manager(this,Cassava.Grid.Factory),this.Tile=new Cassava.Tile.Factory(this),this.Screen=new Cassava.Manager(this,Cassava.Screen.Factory),this.Hitbox=new Cassava.Hitbox.Factory(this),this.Action=new Cassava.Action.Factory(this),this.Audio=new Cassava.AudioManager(this),this.Camera=new Cassava.Camera(this),this.camera=this.Camera,this.Pointer=new Cassava.Pointer(this._canvas,this),this._assetsLoader=new Cassava.Assets.Loader(this)},Cassava.Game.prototype={assets:function(a){return this._assetsLoaded=!1,this._assetsLoader.load(a),this},onAssetsReady:function(){this._assetsLoaded=!0,this._loadAssetsInFactories(),this._waitingScreen&&(this._waitingScreen=!1,this.loadScreen(this._waitingScreenName,this._waitingScreenDatas),this._waitingScreenName=this._waitingScreenDatas=null)},_loadAssetsInFactories:function(){var a,b=this._assetsLoader.resourcesBuffer;for(a=this.Sprite._factories.firstNode;a;)a.o.buildSpriteSheet(b),a=a.next},initialState:function(a){return this.state=a,this},background:function(a){return this._color=a,this},goToScreen:function(a,b){this._waitingScreen=!0,this._waitingScreenName=a,this._waitingScreenDatas=b},startAtScreen:function(a,b){this._assetsLoaded?this.loadScreen(a,b):(this._waitingScreen=!0,this._waitingScreenName=a,this._waitingScreenDatas=b)},loadScreen:function(a,b){this._currentScreen&&this._currentScreen.free(),this._currentScreen=this.Screen.create(a,b),this.Camera.screen=this._currentScreen,this._isRunning||(this._isRunning=!0,this._run())},_initCanvas:function(){if(this._canvas=document.getElementById(this.name),this._context=this._canvas.getContext("2d"),!this._canvas)throw new Error('<canvas id="'+this.name+'"></canvas> must be added in your document.');1===this.scale?(this._canvas.width=this.width,this._canvas.height=this.height):(this._canvas.width=this.width*this.scale,this._canvas.height=this.height*this.scale,this._context.mozImageSmoothingEnabled=!1,this._context.webkitImageSmoothingEnabled=!1,this._context.msImageSmoothingEnabled=!1,this._context.imageSmoothingEnabled=!1,this._cachedCanvas=document.createElement("canvas"),this._cachedCanvasContext=this._cachedCanvas.getContext("2d"))},_updateLogic:function(a){var b,c;for(b=0;b<a.length;++b)if(a[b])for(c=a[b].firstNode;c;)c.o.update&&c.o.update(),c=c.next},_updateSprites:function(a){var b,c;for(b=0;b<a.length;++b)if(a[b])for(c=a[b].firstNode;c;)c.o.sprite&&c.o.sprite.update(),c=c.next},_render:function(a){this._cachedCanvasContext?(this._renderInContext(a,this._cachedCanvasContext),this._context.drawImage(this._cachedCanvas,0,0,this.width,this.height,0,0,this.width*this.scale,this.height*this.scale)):this._renderInContext(a,this._context)},_renderInContext:function(a,b){var c,d,e;for(e=!1,b.fillStyle=this._color,b.fillRect(0,0,this.width,this.height),c=0;c<a.length;++c)if(a[c])for(d=a[c].firstNode;d;)d.o.sprite&&d.o.isInScope&&d.o.sprite.isVisible&&(d.o.sprite.rotation&&(e||(e=!0,b.save()),b.translate(d.o.x+this.Camera.x,d.o.y+this.Camera.y),b.rotate(d.o.sprite.rotation),b.translate(-d.o.x-this.Camera.x,-d.o.y-this.Camera.y)),b.globalAlpha=d.o.sprite.alpha,b.drawImage(d.o.sprite.cachedFrame,~~d.o.sprite.x,~~d.o.sprite.y),e&&(b.restore(),e=!1),b.globalAlpha=1),d=d.next},_run:function(){var a,b,c=this;(b=function(){requestAnimationFrame(b),c._currentScreen&&(c._currentScreen.applyActions(),a=c.Camera.getElementsToRender(),c._updateLogic(a),c._currentScreen.update(a),c._updateSprites(a),c._render(a),c._waitingScreen&&(c._waitingScreen=!1,c.loadScreen(c._waitingScreenName,c._waitingScreenDatas),c._waitingScreenName=c._waitingScreenDatas=null))})()},freeCurrentScreen:function(){this._currentScreen=null},defineStateMachineModule:function(a,b){var c,d,e,f,g,h={};if(!b.states)throw new Error("States not defined in "+a+" state machine config.");h.config=b;for(c in b.states)if(b.states.hasOwnProperty(c)){b.initial===c&&(h.currentState=b.states[c],h.actionTTL=b.states[c].ttl),b.states[c].nextStatesArray=[];for(e in b.states[c].next)if(b.states[c].next.hasOwnProperty(e))for(d=0;d<b.states[c].next[e];++d)b.states[c].nextStatesArray.push(e)}g=function(){if(this.actionTTL>0)this.currentState.action(this,this.entity),this.actionTTL--;else{if(f=this.config.states[this.currentState.nextStatesArray[~~(this.currentState.nextStatesArray.length*Math.random())]],!f)throw new Error("Module: "+this._name+": Invalid next step");this.currentState=f,this.actionTTL=f.ttl}},this.Module.define(a).data(h).onUpdate(g)}},Cassava.Camera=function(a){this.screen=null,this._game=a,this._scope=a.Hitbox.create(Cassava.Hitbox.RECTANGLE_TYPE,{width:a.width,height:a.height}),this._elementsInScope=[],this._spritesOrdering={}},Cassava.Camera.PLACE_BY_Y2=function(a,b){return a.y2<=b.y2},Cassava.Camera.prototype={goTo:function(a,b){return this.x=a,this.y=b,this},getElementsToRender:function(){var a,b,c,d;for(a=0;a<this._elementsInScope.length;++a)this._elementsInScope[a]&&this._elementsInScope[a].clear();if(null===this.screen)throw new Error("Camera doesn't look at any screen");for(c=this.screen.entities.firstNode;c;){for(d=c.o.firstNode;d;)d.o.hitbox.collidesWith(this._scope)?(d.o.isInScope=!0,d.o.sprite&&this._updateElementsSpriteCoordinates(d.o),b=d.o.z,this._elementsInScope[b]||(this._elementsInScope[b]=this._game.LinkedList.create()),this._spritesOrdering[b]?this._elementsInScope[b].pushWhen(d.o,this._spritesOrdering[b]):this._elementsInScope[b].push(d.o)):d.o.updateAnyways&&(d.o.isInScope=!1,b=d.o.z,this._elementsInScope[b]||(this._elementsInScope[b]=this._game.LinkedList.create()),this._spritesOrdering[b]?this._elementsInScope[b].pushWhen(d.o,this._spritesOrdering[b]):this._elementsInScope[b].push(d.o)),d=d.next;c=c.next}return this.screen.grid&&this.screen.grid.getTilesInScope(this._scope,this._elementsInScope),this._elementsInScope},ordering:function(a){return this._spritesOrdering=a,this},_updateElementsSpriteCoordinates:function(a){a.sprite.x=~~((Cassava.fixedFloat(100*a.x)+(Cassava.fixedFloat(100*a.spriteDeltaX)||0)-Cassava.fixedFloat(100*this.x))/100),a.sprite.y=~~((Cassava.fixedFloat(100*a.y)+(Cassava.fixedFloat(100*a.spriteDeltaY)||0)-Cassava.fixedFloat(100*this.y))/100),a.sprite.z=a.z}},Object.defineProperties(Cassava.Camera.prototype,{x:{get:function(){return this._scope._x},set:function(a){this._scope.x=a}},x2:{get:function(){return this._scope.x2}},y:{get:function(){return this._scope._y},set:function(a){this._scope.y=a}},y2:{get:function(){return this._scope.y2}},width:{get:function(){return this._scope._width}},height:{get:function(){return this._scope._height}}}),Cassava.Assets={},Cassava.Assets.IMAGE=0,Cassava.Assets.AUDIO=1,Cassava.Assets.Loader=function(a){this._game=a,this.resourcesBuffer={}},Cassava.Assets.Loader.prototype={load:function(a){var b,c,d=0,e=0,f=a.length,g=!1,h=this._game,i=this,j=function(){++e,e!==f||g||(g=!0,h.onAssetsReady())},k=function(a){throw a},l=function(){var a=this;h.Audio.decode(a.cassava_assetsloader_name,this.response,function(b){i.resourcesBuffer[a.cassava_assetsloader_name]=b,j()},k)};for(0===f&&h.onAssetsReady(),d;f>d;++d)if(b=a[d].name||a[d].src,void 0===this.resourcesBuffer[b])switch(a[d].type){case void 0:case Cassava.Assets.IMAGE:this.resourcesBuffer[b]=new Image,this.resourcesBuffer[b].onload=j,this.resourcesBuffer[b].onerror=k,this.resourcesBuffer[b].src=a[d].src;break;case Cassava.Assets.AUDIO:c=new window.XMLHttpRequest,c.open("GET",a[d].src,!0),c.onload=l,c.responseType="arraybuffer",c.cassava_assetsloader_name=b,c.send()}else++e;e!==f||g||(g=!0,h.onAssetsReady())}},Cassava.SpriteSheetCache=function(a,b,c){this._spriteSheet=a,this._spriteSheetWidth=this._spriteSheet.width,this._spriteSheetHeight=this._spriteSheet.height,this.spriteWidth=b||this._spriteSheetWidth,this.spriteHeight=c||this._spriteSheetHeight,this._numberOfFramesOnWidth=this.spriteWidth?~~(this._spriteSheetWidth/this.spriteWidth):0,this._numberOfFramesOnHeight=this.spriteHeight?~~(this._spriteSheetHeight/this.spriteHeight):0,this._numberOfFrames=this._numberOfFramesOnWidth*this._numberOfFramesOnHeight,this._frames=[],this._initFrames()},Cassava.SpriteSheetCache.prototype={_initFrames:function(){for(var a,b,c=0;c<this._numberOfFrames;++c)a=document.createElement("canvas"),a.width=this.spriteWidth,a.height=this.spriteHeight,b=a.getContext("2d"),b.drawImage(this._spriteSheet,c%this._numberOfFramesOnWidth*this.spriteWidth,~~(c/this._numberOfFramesOnWidth)*this.spriteHeight,this.spriteWidth,this.spriteHeight,0,0,this.spriteWidth,this.spriteHeight),this._frames[c]=a},frame:function(a){if(!this._frames[a])throw new Error("Frame "+a+" not found.");return this._frames[a]}},Cassava.Manager=function(a,b){this.game=a,this._factoryTemplate=b,this._pool=[],this._factories=this.game.LinkedList.create(),this.create=this._factoryTemplate.create},Cassava.Manager.prototype={define:function(a){var b;if(void 0!==this._factories.map[a])throw new Error(a+" factory already defined");return b=new this._factoryTemplate(a,this),this._factories.push(b),b},free:function(a){this._pool.push(a)},factory:function(a){return this._factories.get(a)}},Cassava.Entity=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){this._isAlive=!1,this._manager=a,this._game=this._manager.game,this.screen=null,this.id=null,this.name=null,this._modules=this._game.LinkedList.create(),this.parent=null,this._children=this._game.LinkedList.create(),this.spriteDeltaX=null,this.spriteDeltaY=null,this.hitbox=null,this.collides=null,this.z=1,this._onCreate=null,this._args=null,this._onFree=null,this._updateAnyways=null,this.isInScope=!0,this.sprite=null,this.init(b,c,d,e,f,g,h,i,j,k,l,m,n)},Cassava.Entity.prototype={init:function(a,b,c,d,e,f,g,h,i,j,k,l,m){return this._isAlive=!0,this.screen=a,this.eventsToAddOnScreenAtCreation=b,this.screen&&this.screen.addEvents(this.eventsToAddOnScreenAtCreation),this.name=c,this.id=Cassava.getId(),this._initModules(d),this._initSprite(e),this.spriteDeltaX=h||0,this.spriteDeltaY=i||0,this._initHitbox(f,g),this._onCreate=j,this._args=k,this._onCreate&&this._onCreate(k,this.screen,this.screen.game),this._onFree=l,this.updateAnyways=m,this},_initModules:function(a){var b,c;if(a)for(b=0;b<a.length;++b)c="object"==typeof a[b]?this._game.Module.create(a[b].type,this,a[b].data):this._game.Module.create(a[b],this),this._modules.push(c)},_initSprite:function(a){a&&(this.sprite=this._game.Sprite.create(a))},_initHitbox:function(a,b){this.hitbox=a?this._game.Hitbox.create(a,b,this):this._game.Hitbox.create(Cassava.Hitbox.POINT_TYPE,null,this)},free:function(){this._isAlive=!1,this.parent&&(this.parent.freeChild(this),this.parent=null),this._onFree&&this._onFree(this.screen,this._game),this._freeList(this._modules),this._freeList(this._children),this.sprite&&(this.sprite.free(),this.sprite=null),this.screen&&this.screen.freeEntity(this),this._manager&&this._manager.free(this)},_freeList:function(a){var b;for(b=a.pop();b;)b.free(),b=a.pop()},freeChild:function(a){this._children.remove(a)},update:function(){this._isAlive&&this._updateModules()},_updateModules:function(){var a;for(a=this._modules.firstNode;a&&this._isAlive;)a.o.update&&a.o.update(this,this.screen,this.screen.game),a=a.next},module:function(a){return this._modules.get(a)},child:function(a){return this._children.get(a)},addChild:function(a,b,c){var d=this.screen.addEntity(a,b);return c&&(d.id=c),d.parent=this,this._children.push(d),d}},Object.defineProperties(Cassava.Entity.prototype,{x:{get:function(){return this.hitbox.x},set:function(a){this.hitbox.x=a}},x2:{get:function(){return this.hitbox.x2}},xCenter:{get:function(){return this.hitbox.xCenter}},width:{get:function(){return this.hitbox.width},set:function(a){this.hitbox._width=a}},y:{get:function(){return this.hitbox.y},set:function(a){this.hitbox.y=a}},y2:{get:function(){return this.hitbox.y2}},yCenter:{get:function(){return this.hitbox.yCenter}},height:{get:function(){return this.hitbox.height},set:function(a){this.hitbox._height=a}},firstChildNode:{get:function(){return this._children.firstNode}},lastChildNode:{get:function(){return this._children.lastNode}}}),Cassava.Entity.Factory=function(a,b){this.id=this._name=a,this._modules=null,this._sprite=null,this._hitbox=null,this._hitboxType=null,this._spriteDeltaX=0,this._spriteDeltaY=0,this._onCreate=null,this._onFree=null,this._updateAnyways=!1,this._manager=b,this._eventsToAddOnScreenAtCreation=[]},Cassava.Entity.Factory.create=function(a,b,c){if(null===this._factories.get(a))throw new Error('Entity template "'+a+'" is not defined.');return 0===this._pool.length?this._factories.get(a).build(b,c):this._factories.get(a).recycle(this._pool.pop(),b,c)},Cassava.Entity.Factory.prototype={modules:function(a){return this._modules=a,this},sprite:function(a){return this._sprite=a,this},hitbox:function(a,b){return this._hitboxDatas=b,this._hitboxType=a,this},spriteDelta:function(a,b){return this._spriteDeltaX=a,this._spriteDeltaY=b,this},updateAnyways:function(){return this._updateAnyways=!0,this},onCreate:function(a){return this._onCreate=a,this},onFree:function(a){return this._onFree=a,this},whenHitsEntities:function(a,b){var c="event_custom"+Cassava.getId();return this._manager.game.Event.define(c).type(Cassava.Event.ENTITY_ENTITY_COLLISION_FOR_ENTITY).when([this._name]).collidesWith(a).so(b),this._eventsToAddOnScreenAtCreation.push(c),this},whenHitsTiles:function(a,b){var c="event_custom"+Cassava.getId();return this._manager.game.Event.define(c).type(Cassava.Event.ENTITY_TILE_COLLISION_FOR_ENTITY).when([this._name]).collidesWith(a).so(b),this._eventsToAddOnScreenAtCreation.push(c),this},whenKeyIsPressed:function(a,b){var c="event_custom"+Cassava.getId();return this._manager.game.Event.define(c).type(Cassava.Event.KEY_PRESSED_FOR_ENTITY).when(a).isPressedSo(b)._arg2=this._name,this._eventsToAddOnScreenAtCreation.push(c),this},whenPointed:function(a){var b="event_custom"+Cassava.getId();return this._manager.game.Event.define(b).type(Cassava.Event.POINTED_ENTITY_FOR_ENTITY).when([this._name]).isPointedSo(a),this._eventsToAddOnScreenAtCreation.push(b),this},build:function(a,b){return new Cassava.Entity(this._manager,b,this._eventsToAddOnScreenAtCreation,this._name,this._modules,this._sprite,this._hitboxType,this._hitboxDatas,this._spriteDeltaX,this._spriteDeltaY,this._onCreate,a,this._onFree,this._updateAnyways)},recycle:function(a,b,c){return a.init(c,this._eventsToAddOnScreenAtCreation,this._name,this._modules,this._sprite,this._hitboxType,this._hitboxDatas,this._spriteDeltaX,this._spriteDeltaY,this._onCreate,b,this._onFree,this._updateAnyways)}},Cassava.Module=function(a,b,c,d,e,f,g){this._factory=a,this._name=c,this.id=this._name,this.initialData=d,this.entity=b,this._game=this.entity.screen.game,this.update=e,this.onInit=f,this.onFree=g},Cassava.Module.prototype={init:function(a){this._initData(),this.onInit&&this.onInit(a)},free:function(){this.onFree&&this.onFree(),this._factory.free(this)},_initData:function(){var a;if(this.initialData)for(a in this.initialData){if(!this._isValidProperty(a))throw new Error('Property "'+a+'" must not be set ('+this._name+" module).");this.initialData.hasOwnProperty(a)&&(this[a]=this.initialData[a])}},_isValidProperty:function(a){return"_factory"!==a&&"_game"!==a&&"id"!==a&&"entity"!==a&&"update"!==a&&"_name"!==a&&"_initialDatas"!==a&&"_isValidProperty"!==a&&"init"!==a&&"_initDatas"!==a&&"isValidProperty"!==a}},Cassava.Module.Factory=function(a,b){this.id=this._name=a,this._manager=b,this._data=null,this._update=null,this._onInit=null,this._onFree=null,this._pool=[]},Cassava.Module.Factory.create=function(a,b,c){if(null===this._factories.get(a))throw new Error('Module template "'+a+'" is not defined.');return this._factories.get(a).get(b,c)},Cassava.Module.Factory.prototype={get:function(a,b){var c;return 0===this._pool.length?c=new Cassava.Module(this,a,this._name,this._data,this._update,this._onInit,this._onFree):(c=this._pool.pop(),c.entity=a),c.init(b),c},data:function(a){return this._data=a,this},onUpdate:function(a){return this._update=a,this},onInit:function(a){return this._onInit=a,this},onFree:function(a){return this._onFree=a,this},free:function(a){this._pool.push(a)}},Cassava.Action={},Cassava.Action.Factory=function(a){this._game=a,this._createEntityPool=[],this._removeEntityPool=[],this._addEventPool=[],this._removeEventPool=[]},Cassava.Action.Factory.prototype={create:function(a,b,c,d){switch(a){case Cassava.Action.CREATE_ENTITY:return 0===this._createEntityPool.length?new Cassava.Action.CreateEntity(this,b,c,d):this._createEntityPool.pop().init(b,c,d);case Cassava.Action.REMOVE_ENTITY:return 0===this._removeEntityPool.length?new Cassava.Action.RemoveEntity(this,b,c):this._removeEntityPool.pop().init(b,c);case Cassava.Action.ADD_EVENT:return 0===this._addEventPool.length?new Cassava.Action.AddEvent(this,b,c):this._addEventPool.pop().init(b,c);case Cassava.Action.REMOVE_EVENT:return 0===this._removeEventPool.length?new Cassava.Action.RemoveEvent(this,b,c):this._removeEventPool.pop().init(b,c);default:throw new Error('Action "'+a+'" does not exist.')}},free:function(a){if(a)switch(a.type){case Cassava.Action.CREATE_ENTITY:this._createEntityPool.push(a);break;case Cassava.Action.REMOVE_ENTITY:this._removeEntityPool.push(a);break;case Cassava.Action.ADD_EVENT:this._addEventPool.push(a);break;case Cassava.Action.REMOVE_EVENT:this._removeEventPool.push(a)}}},Cassava.Action.CREATE_ENTITY=0,Cassava.Action.CreateEntity=function(a,b,c){this.id=Cassava.getId(),this.type=Cassava.Action.CREATE_ENTITY,this._factory=a,this._game=this._factory._game,this._screen=null,this._entity=null,this.init(b,c)},Cassava.Action.CreateEntity.prototype={init:function(a,b){return this._screen=a,this._entity=b,this},apply:function(){var a;this._entity&&(null===this._screen.entities.get(this._entity.name)&&(a=this._game.LinkedList.create(),a.id=this._entity.name,this._screen.entities.push(a)),this._screen.entities.get(this._entity.name).push(this._entity)),this._factory.free(this)}},Cassava.Action.REMOVE_ENTITY=1,Cassava.Action.RemoveEntity=function(a,b,c){this.id=Cassava.getId(),this.type=Cassava.Action.REMOVE_ENTITY,this._factory=a,this._game=this._factory._game,this._screen=null,this._entity=null,this.init(b,c)},Cassava.Action.RemoveEntity.prototype={init:function(a,b){return this._screen=a,this._entity=b,this},apply:function(){this._entity&&this._entity._isAlive&&(this._screen.entities.get(this._entity.name).remove(this._entity),this._entity.free()),this._factory.free(this)}},Cassava.Action.ADD_EVENT=2,Cassava.Action.AddEvent=function(a,b,c){this.id=Cassava.getId(),this.type=Cassava.Action.ADD_EVENT,this._factory=a,this._game=this._factory._game,this._screen=null,this._event=null,this.init(b,c)},Cassava.Action.AddEvent.prototype={init:function(a,b){return this._screen=a,this._event=b,this},apply:function(){null===this._screen._events.get(this._event.name)?this._screen._events.push(this._event):(this._event.screen=null,this._event.free()),this._factory.free(this)}},Cassava.Action.REMOVE_EVENT=3,Cassava.Action.RemoveEvent=function(a,b,c){this.id=Cassava.getId(),this.type=Cassava.Action.REMOVE_EVENT,this._factory=a,this._game=this._factory._game,this._screen=null,this._eventName=null,this.init(b,c)},Cassava.Action.RemoveEvent.prototype={init:function(a,b){return this._screen=a,this._eventName=b,this},apply:function(){this._screen._events.has(this._eventName)&&this._screen._events.get(this._eventName).free(),this._factory.free(this)}},Cassava.Hitbox={},Cassava.Hitbox.Factory=function(a){this._game=a,this._rectanglePool=[],this._pointPool=[]},Cassava.Hitbox.Factory.prototype={create:function(a,b){switch(a){case Cassava.Hitbox.RECTANGLE_TYPE:return 0===this._rectanglePool.length?new Cassava.Hitbox.Rectangle(b,this):this._rectanglePool.pop().init(b);case Cassava.Hitbox.POINT_TYPE:return 0===this._pointPool.length?new Cassava.Hitbox.Point(this):this._pointPool.pop().init();default:throw new Error("Hitbox "+a+" does not exist.")}},free:function(a){switch(a.type){case Cassava.Hitbox.RECTANGLE_TYPE:this._rectanglePool.push(a);break;case Cassava.Hitbox.POINT_TYPE:this._pointPool.push(a)}}},Cassava.Hitbox.RECTANGLE_TYPE=1,Cassava.Hitbox.Rectangle=function(a,b){this._factory=b,this.type=Cassava.Hitbox.RECTANGLE_TYPE,this._x=null,this._y=null,this._width=null,this._height=null,this.init(a)},Cassava.Hitbox.Rectangle.prototype={init:function(a){return this._x=a.x||0,this._y=a.y||0,this._width=a.width||0,this._height=a.height||0,this},hasPoint:function(a){return a.x>=this.x&&a.x<=this.x2&&a.y>=this.y&&a.y<=this.y2},collidesWith:function(a){switch(a.type){case Cassava.Hitbox.RECTANGLE_TYPE:return!(this.y2<=a.y||this.y>=a.y2||this.x>=a.x2||this.x2<=a.x);case Cassava.Hitbox.POINT_TYPE:return this.hasPoint(a);default:return!1}}},Object.defineProperties(Cassava.Hitbox.Rectangle.prototype,{x:{get:function(){return this._x},set:function(a){this._x=a}},x2:{get:function(){return this._x+this._width}},xCenter:{get:function(){return this._x+this._width/2}},width:{get:function(){return this._width},set:function(a){this._width=a}},y:{get:function(){return this._y},set:function(a){this._y=a}},y2:{get:function(){return this.y+this._height}},yCenter:{get:function(){return this._y+this._height/2}},height:{get:function(){return this._height},set:function(a){this._height=a}}}),Cassava.Hitbox.POINT_TYPE=0,Cassava.Hitbox.Point=function(a){this._factory=a,this.type=Cassava.Hitbox.POINT_TYPE,this.x=null,this.y=null,this.init()},Cassava.Hitbox.Point.prototype={init:function(){return this.x=0,this.y=0,this},hasPoint:function(a){return a.x===this._x&&a.y===this._x},collidesWith:function(a){switch(a.type){case Cassava.Hitbox.RECTANGLE_TYPE:return this.x>=a.x&&this.x<=a.x2&&this.y>=a.y&&this.y<=a.y2;case Cassava.Hitbox.POINT_TYPE:return a.x===this.x&&a.y===this.y;default:return!1}}},Object.defineProperties(Cassava.Hitbox.Point.prototype,{x2:{get:function(){return this.x}},xCenter:{get:function(){return this.x}},width:{get:function(){return 0},set:function(){throw new Error("Width of Point Hitbox cannot be set")}},y2:{get:function(){return this.y}},yCenter:{get:function(){return this.y}},height:{get:function(){return 0},set:function(){throw new Error("Height of Point Hitbox cannot be set")}}}),Cassava.Grid=function(a,b,c,d,e,f){this._manager=a,this._game=this._manager.game,this._name=b,this._id=Cassava.getId(),this._sprite=null,this._tileTypes=null,this._tileWidth=null,this._tileHeight=null,this._struct=null,this._width=null,this.tiles=null,this._temporaryList=this._game.LinkedList.create(),this.init(c,d,e,f)},Cassava.Grid.prototype={init:function(a,b,c,d){if(!b)throw new Error("Bad grid "+this._name+" definition : tilesTypes is not defined.");if(!c)throw new Error("Bad grid "+this._name+" definition : struct is not defined.");return this._struct=c,this._tileTypes=b,this._initTilesDimensions(a),this._width=d,this._initTiles(a),this},_initTiles:function(a){var b,c,d;for(c=d=0,this.tiles?this.tiles.length=0:this.tiles=[],b=0;b<this._struct.length;++b)this.tiles[b]=this._game.Tile.create(a,this._tileTypes,this._struct[b],c,d,this._tileWidth,this._tileHeight,b),c+=this._tileWidth,c>=this._width*this._tileWidth&&(c=0,d+=this._tileHeight)},_initTilesDimensions:function(a){this._tileWidth=this._game.Sprite.factory(a)&&this._game.Sprite.factory(a).spriteSheetCache.spriteWidth||1,this._tileHeight=this._game.Sprite.factory(a)&&this._game.Sprite.factory(a).spriteSheetCache.spriteHeight||1},free:function(){this._freeTiles(),this._manager.free(this)},_freeTiles:function(){var a;for(a=0;a<this.tiles.length;++a)this.tiles[a].free;this._manager.free(this)},_indexByPixelCoordinates:function(a,b){return this._width*~~(b/this._tileHeight)+~~(a/this._tileWidth)},tileByCoordinates:function(a,b){return this.tiles[this._indexByPixelCoordinates(a,b)]},getTilesInScope:function(a,b){var c,d;for(d=this.getCollidingTiles(a,null),c=d.pop();c;)c.type!==Cassava.Tile.TYPE_EMPTY&&(this._updateSpriteOfTile(c,a),b[c.z]||(b[c.z]=this._game.LinkedList.create()),b[c.z].push(c)),c=d.pop()},_updateSpriteOfTile:function(a,b){a.sprite.x=~~(a.x-b.x),a.sprite.y=~~(a.y-b.y),a.sprite.z=a.z},getCollidingTiles:function(a,b){if(this._temporaryList.clear(),void 0!==a.type)switch(a.type){case Cassava.Hitbox.RECTANGLE_TYPE:this._getRectangleCollidingTiles(a,b);break;case Cassava.Hitbox.POINT_TYPE:this._getPointCollidingTiles(a,b)}return this._temporaryList},_getRectangleCollidingTiles:function(a,b){for(var c=this._indexByPixelCoordinates(a.x,a.y),d=this._indexByPixelCoordinates(a.x2-1,a.y2-1),e=c%this._width,f=d%this._width,g=c;d>=g;)b&&b.length>0?this.tiles[g]&&-1!==b.indexOf(this.tiles[g].type)&&this._temporaryList.push(this.tiles[g]):this.tiles[g]&&this._temporaryList.push(this.tiles[g]),(g+1)%this._width>f||(g+1)%this._width<e?g+=this._width-(f-e):++g},_getPointCollidingTiles:function(a,b){var c=this.tiles[this._indexByPixelCoordinates(a.x,a.y)];return c&&-1!==b.indexOf(c.type)&&this._temporaryList.push(c),this._temporaryList}},Cassava.Grid.Factory=function(a,b){this.id=this._name=a,this._manager=b,this._sprite=null,this._tileTypes=null},Cassava.Grid.Factory.create=function(a,b,c){if(null===this._factories.get(a))throw new Error('Grid template "'+a+'" is not defined.');if(void 0===b)throw new Error("Grid "+a+"'s structure is not defined");if(void 0===c)throw new Error("Grid "+a+"'s width is not defined");return 0===this._pool.length?this._factories.get(a).build(b,c):this._factories.get(a).recycle(this._pool.pop(),b,c)},Cassava.Grid.Factory.prototype={sprite:function(a){return this._sprite=a,this},tileTypes:function(a){return this._tileTypes=a,this},build:function(a,b){return new Cassava.Grid(this._manager,this._name,this._sprite,this._tileTypes,a,b)},recycle:function(a,b,c){return a.init(this._sprite,this._tileTypes,b,c)},free:function(a){this._pool.push(a)}},Cassava.Tile=function(a,b,c,d,e,f,g,h,i){this._factory=a,this._game=this._factory.game,this.id=Cassava.getId(),this._spriteName=null,this.sprite=null,this._config=null,this._type=null,this.x=null,this.y=null,this.z=null,this.index=null,this.hitbox=null,this.isInScope=!0,this.init(b,c,d,e,f,g,h,i)},Cassava.Tile.TYPE_EMPTY=0,Cassava.Tile.prototype={init:function(a,b,c,d,e,f,g,h){this.config=b,this._spriteName=a,this.z=0,this.hitbox=this._game.Hitbox.create(Cassava.Hitbox.RECTANGLE_TYPE,{width:f,height:g}),this.hitbox.x=d,this.hitbox.y=e,this.type=c,this.index=h},free:function(){this.sprite.free(),this._factory.free(this)},updateSpriteCoordinates:function(){this.sprite.x=this.x,this.sprite.y=this.y}},Object.defineProperties(Cassava.Tile.prototype,{type:{get:function(){return this._type},set:function(a){this._type=a,this._type!==Cassava.Tile.TYPE_EMPTY?(this.sprite||(this.sprite=this._game.Sprite.create(this._spriteName)),this.config[a]&&void 0!==this.config[a].sequence?this.sprite.show().sequence=this.config[a].sequence:this.sprite.hide(),this.z=this.config[a]&&this.config[a].z||this.z):this.sprite&&this.sprite.hide()}},x:{get:function(){return this.hitbox.x}},x2:{get:function(){return this.hitbox.x2}},xCenter:{get:function(){return this.hitbox.xCenter
}},width:{get:function(){return this.hitbox.width}},y:{get:function(){return this.hitbox.y}},y2:{get:function(){return this.hitbox.y2}},yCenter:{get:function(){return this.hitbox.yCenter}},height:{get:function(){return this.hitbox.height}}}),Cassava.Tile.Factory=function(a){this.game=a,this._pool=[]},Cassava.Tile.Factory.prototype={create:function(a,b,c,d,e,f,g,h){return 0===this._pool.length?new Cassava.Tile(this,a,b,c,d,e,f,g,h):this._pool.pop().init(a,b,c,d,e,f,g,h)},free:function(a){this._pool.push(a)}},Cassava.Screen=function(a,b,c,d,e,f,g,h,i,j,k){this._isAlive=!1,this.id=null,this._manager=a,this.game=this._manager.game,this._name=null,this.grid=null,this.entities=this.game.LinkedList.create(),this._actions=this.game.LinkedList.create(),this._events=this.game.LinkedList.create(),this._postEventsHandler=null,this._onCreate=null,this._args=null,this.init(b,c,d,e,f,g,h,i,j,k)},Cassava.Screen.prototype={init:function(a,b,c,d,e,f,g,h,i,j){return this._isAlive=!0,this._name=a,this.id=Cassava.getId(),this._initGrid(c,d,e),this._initEvents(g),this._postEventsHandler=null,this._initPostEventModules(h),this._initEntities(f),this._onCreate=i,this._args=j,this._onCreate&&this._onCreate(this._args,this.game),this},_initEntities:function(a){var b;if(this._freeEntities(),a)for(b=0;b<a.length;++b)this.addEntity(a[b].type,a[b].data)},_initEvents:function(a){var b;if(this._freeList(this._events),a)for(b=0;b<a.length;++b)this._events.push(this.game.Event.create(a[b],this))},_initPostEventModules:function(a){this._postEventsHandler=this.game.Entity.create("entity_default",null,this),this._postEventsHandler._initModules(a)},_initGrid:function(a,b,c){a&&b&&c&&(this.grid=this.game.Grid.create(a,b,c))},_freeList:function(a){var b;for(b=a.pop();b;)b.free(),b=a.pop()},free:function(){this._isAlive=!1,this._freeEntities(),this._postEventsHandler.free(),this._freeList(this._events),this.grid&&(this.grid.free(),this.grid=null),this._manager.free(this),this.game.freeCurrentScreen()},_freeEntities:function(){var a;for(a=this.entities.pop();a;)this._freeList(a),a.free(),a=this.entities.pop()},freeEntity:function(a){a&&this.entities.get(a.name)&&(this.entities.get(a.name).remove(a),this.entities.get(a.name).isEmpty()&&this.removeEvents(a.eventsToAddOnScreenAtCreation))},freeEvent:function(a){a&&this._events.remove(a)},_logAction:function(a,b,c){this._actions.push(this.game.Action.create(a,this,b,c))},addEntity:function(a,b){var c=this.game.Entity.create(a,b,this);return this._logAction(Cassava.Action.CREATE_ENTITY,c),c},removeEntity:function(a){this._logAction(Cassava.Action.REMOVE_ENTITY,a)},addEvent:function(a){var b=this.game.Event.create(a,this);return this._logAction(Cassava.Action.ADD_EVENT,b),b},addEvents:function(a){for(var b=0;b<a.length;++b)this.addEvent(a[b])},removeEvent:function(a){this._logAction(Cassava.Action.REMOVE_EVENT,a)},removeEvents:function(a){for(var b=0;b<a.length;++b)this.removeEvent(a[b])},getEntity:function(a,b){return this.entities.get(a)?this.entities.get(a).get(b):null},ifEntity:function(a,b,c){this.entities.get(a)&&this.entities.get(a).get(b)&&c(this.entities.get(a).get(b),this,this.game)},update:function(a){this._isAlive&&(this._updateEvents(a),this._isAlive&&this._updatePostEventsModules())},applyActions:function(){var a;for(a=this._actions.pop();a&&this._isAlive;)a.apply(),a=this._actions.pop()},_updateEvents:function(a){var b;for(b=this._events.firstNode;b&&this._isAlive;)b.o.update(a),b=b.next},_updatePostEventsModules:function(){this._postEventsHandler.update()},postEventsModule:function(a){return this._postEventsHandler.module(a)}},Cassava.Screen.Factory=function(a,b){this.id=this._name=a,this._camera=null,this._grid=null,this._entities=null,this._events=null,this._postEventModules=null,this._onCreate=null,this._manager=b},Cassava.Screen.Factory.create=function(a,b){if(null===this._factories.get(a))throw new Error('Screen template "'+a+'" is not defined.');return 0===this._pool.length?this._factories.get(a).build(b):this._factories.get(a).recycle(this._pool.pop(),b)},Cassava.Screen.Factory.prototype={camera:function(a){return this._camera=a,this},grid:function(a,b,c){return this._gridName=a,this._gridStruct=b,this._gridWidth=c,this},entities:function(a){return this._entities=a,this},events:function(a){return this._events=a,this},postEventModules:function(a){return this._postEventModules=a,this},onCreate:function(a){return this._onCreate=a,this},build:function(a){return new Cassava.Screen(this._manager,this._name,this._camera,this._gridName,this._gridStruct,this._gridWidth,this._entities,this._events,this._postEventModules,this._onCreate,a)},recycle:function(a,b){return a.init(this._name,this._camera,this._gridName,this._gridStruct,this._gridWidth,this._entities,this._events,this._postEventModules,this._onCreate,b)}},Cassava.Event=function(a,b,c,d,e,f,g,h,i){this._manager=a,this.screen=null,this.game=this._manager._game,this.name=null,this.id=null,this.update=null,this._callback=null,this.init(b,c,d,e,f,g,h,i)},Cassava.Event.prototype={init:function(a,b,c,d,e,f,g,h){return this.name=d,this.id=this.name,this.screen=a,this.update=b,this._callback=e,this._initMethod=c,this._initMethod(f,g,h),this},free:function(){this.screen&&this.screen.freeEvent(this),this._manager.free(this)}},Cassava.Event.POINTED_TILE=0,Cassava.Event.POINTED_ENTITY=1,Cassava.Event.ENTITY_TILE_COLLISION=2,Cassava.Event.ENTITY_TILE_COLLISION_FOR_ENTITY=3,Cassava.Event.ENTITY_ENTITY_COLLISION=4,Cassava.Event.KEY_PRESSED=5,Cassava.Event.ENTITY_ENTITY_COLLISION_FOR_ENTITY=6,Cassava.Event.KEY_PRESSED_FOR_ENTITY=7,Cassava.Event.POINTED_ENTITY=8,Cassava.Event.POINTED_ENTITY_FOR_ENTITY=9,Cassava.Event.POINTED_TILE=10,Cassava.Event.KEY_PRESSED_INIT=function(a){this._key=a},Cassava.Event.KEY_PRESSED_FOR_ENTITY_INIT=function(a,b){this._key=a,this._entity=b},Cassava.Event.KEY_PRESSED_UPDATE=function(){Cassava.isPushed(this._key)&&this._callback(this.screen,this.screen.game)},Cassava.Event.KEY_PRESSED_FOR_ENTITY_UPDATE=function(){if(Cassava.isPushed(this._key)){var a;if(this.screen.entities.get(this._entity))for(a=this.screen.entities.get(this._entity).firstNode;a;)a.o.tmpCallback=this._callback,a.o.tmpCallback(this.screen,this.screen.game),a.o.tmpCallback=null,a=a.next}},Cassava.Event.ENTITY_ENTITY_COLLISION_INIT=function(a,b){this._firstEntitiesType=a,this._secondEntitiesType=b},Cassava.Event.ENTITY_ENTITY_COLLISION_UPDATE=function(a){var b,c,d,e;for(b=0;b<this._firstEntitiesType.length;++b)for(c=0;c<this._secondEntitiesType.length;++c)if(this.screen.entities.get(this._firstEntitiesType[b])&&this.screen.entities.get(this._secondEntitiesType[c]))for(d=this.screen.entities.get(this._firstEntitiesType[b]).firstNode;d;)if(!a[d.o.z]||a[d.o.z].has(d.o)){for(e=this.screen.entities.get(this._secondEntitiesType[c]).firstNode;e;)d!==e?!a[e.o.z]||a[e.o.z]&&!a[e.o.z].has(e.o)?e=e.next:(d.o.hitbox.collidesWith(e.o.hitbox)&&this._callback(d.o,e.o,this.screen,this.screen.game),e=e.next):e=e.next;d=d.next}else d=d.next},Cassava.Event.ENTITY_ENTITY_COLLISION_FOR_ENTITY_UPDATE=function(a){var b,c,d,e;for(b=0;b<this._firstEntitiesType.length;++b)for(c=0;c<this._secondEntitiesType.length;++c)if(this.screen.entities.get(this._firstEntitiesType[b])&&this.screen.entities.get(this._secondEntitiesType[c]))for(d=this.screen.entities.get(this._firstEntitiesType[b]).firstNode;d;)if(!a[d.o.z]||a[d.o.z].has(d.o)){for(e=this.screen.entities.get(this._secondEntitiesType[c]).firstNode;e;)d!==e&&(!a[e.o.z]||a[e.o.z].has(e.o))?(d.o.hitbox.collidesWith(e.o.hitbox)&&(d.o.tmpCallback=this._callback,d.o.tmpCallback(e.o,this.screen,this.screen.game),d.o.tmpCallback=void 0),e=e.next):e=e.next;d=d.next}else d=d.next},Cassava.Event.ENTITY_TILE_COLLISION_INIT=function(a,b){this._entitiesTypes=a,this._tilesTypes=b},Cassava.Event.ENTITY_TILE_COLLISION_UPDATE=function(a){var b,c,d,e;if(this.screen.grid)for(b=0;b<this._entitiesTypes.length;++b)for(c=0;c<this._tilesTypes.length;++c)if(this.screen.entities.get(this._entitiesTypes[b]))for(d=this.screen.entities.get(this._entitiesTypes[b]).firstNode;d;)!a[d.o.z]||a[d.o.z].has(d.o)?(e=this.screen.grid.getCollidingTiles(d.o.hitbox,this._tilesTypes),e.isEmpty()||this._callback(d.o,e,this.screen,this.screen.game),d=d.next):d=d.next},Cassava.Event.ENTITY_TILE_COLLISION_FOR_ENTITY_UPDATE=function(a){var b,c,d,e;if(this.screen.grid)for(b=0;b<this._entitiesTypes.length;++b)for(c=0;c<this._tilesTypes.length;++c)if(this.screen.entities.get(this._entitiesTypes[b]))for(d=this.screen.entities.get(this._entitiesTypes[b]).firstNode;d;)!a[d.o.z]||a[d.o.z]&&!a[d.o.z].has(d.o)?d=d.next:(e=this.screen.grid.getCollidingTiles(d.o.hitbox,this._tilesTypes),e.isEmpty()||(d.o.tmpCallback=this._callback,d.o.tmpCallback(e,this.screen,this.screen.game),d.o.tmpCallback=void 0),d=d.next)},Cassava.Event.POINTED_ENTITY_INIT=function(a){this._entitiesTypes=a},Cassava.Event.POINTED_ENTITY_UPDATE=function(){var a,b;for(a=0;a<this._entitiesTypes.length;++a)if(this.screen.entities.get(this._entitiesTypes[a]))for(b=this.screen.entities.get(this._entitiesTypes[a]).firstNode;b;)this.screen.game.Pointer.isPointing&&b.o.hitbox.collidesWith(this.screen.game.Pointer.position)&&this._callback(b.o,this.screen.game.Pointer.position,this.screen,this.screen.game),b=b.next},Cassava.Event.POINTED_ENTITY_FOR_ENTITY_UPDATE=function(){var a,b;for(a=0;a<this._entitiesTypes.length;++a)if(this.screen.entities.get(this._entitiesTypes[a]))for(b=this.screen.entities.get(this._entitiesTypes[a]).firstNode;b;)this.screen.game.Pointer.isPointing&&b.o.hitbox.collidesWith(this.screen.game.Pointer.position)&&(b.o.tmpCallback=this._callback,b.o.tmpCallback(this.screen.game.Pointer.position,this.screen,this.screen.game),b.o.tmpCallback=null),b=b.next},Cassava.Event.POINTED_TILE_INIT=function(a){this._tilesTypes=a},Cassava.Event.POINTED_TILE_UPDATE=function(){var a,b;if(this.screen.game.Pointer.isPointing)for(a=0;a<this._tilesTypes.length;++a)b=this.screen.grid.getCollidingTiles(this.screen.game.Pointer.position,this._tilesTypes),b.isEmpty()||this._callback(b.firstNode.o,this.screen.game.Pointer.position,this.screen,this.screen.game)},Cassava.Event.HOVERED_ENTITY_INIT=function(a){this._entities=a},Cassava.Event.HOVERED_ENTITY_UPDATE=function(){},Cassava.Event.Factory=function(a,b){this.id=this._name=a,this._manager=b,this._type=null,this._arg1=null,this._arg2=null,this._arg3=null,this._callback=null,this._init=null,this._update=null},Cassava.Event.Factory.prototype={type:function(a){switch(this._type=a,this._type){case Cassava.Event.POINTED_TILE:this._init=Cassava.Event.POINTED_TILE_INIT,this._update=Cassava.Event.POINTED_TILE_UPDATE;break;case Cassava.Event.POINTED_ENTITY:this._init=Cassava.Event.POINTED_ENTITY_INIT,this._update=Cassava.Event.POINTED_ENTITY_UPDATE;break;case Cassava.Event.ENTITY_TILE_COLLISION:this._init=Cassava.Event.ENTITY_TILE_COLLISION_INIT,this._update=Cassava.Event.ENTITY_TILE_COLLISION_UPDATE;break;case Cassava.Event.ENTITY_TILE_COLLISION_FOR_ENTITY:this._init=Cassava.Event.ENTITY_TILE_COLLISION_INIT,this._update=Cassava.Event.ENTITY_TILE_COLLISION_FOR_ENTITY_UPDATE;break;case Cassava.Event.ENTITY_ENTITY_COLLISION:this._init=Cassava.Event.ENTITY_ENTITY_COLLISION_INIT,this._update=Cassava.Event.ENTITY_ENTITY_COLLISION_UPDATE;break;case Cassava.Event.ENTITY_ENTITY_COLLISION_FOR_ENTITY:this._init=Cassava.Event.ENTITY_ENTITY_COLLISION_INIT,this._update=Cassava.Event.ENTITY_ENTITY_COLLISION_FOR_ENTITY_UPDATE;break;case Cassava.Event.KEY_PRESSED:this._init=Cassava.Event.KEY_PRESSED_INIT,this._update=Cassava.Event.KEY_PRESSED_UPDATE;break;case Cassava.Event.KEY_PRESSED_FOR_ENTITY:this._init=Cassava.Event.KEY_PRESSED_FOR_ENTITY_INIT,this._update=Cassava.Event.KEY_PRESSED_FOR_ENTITY_UPDATE;break;case Cassava.Event.POINTED_ENTITY:this._init=Cassava.Event.POINTED_ENTITY_INIT,this._update=Cassava.Event.POINTED_ENTITY_UPDATE;break;case Cassava.Event.POINTED_ENTITY_FOR_ENTITY:this._init=Cassava.Event.POINTED_ENTITY_INIT,this._update=Cassava.Event.POINTED_ENTITY_FOR_ENTITY_UPDATE;break;default:throw new Error("Event type not defined")}return this},when:function(a){return this._arg1=a,this},collidesWith:function(a){return this._arg2=a,this},isPressedSo:function(a){return this._callback=a,this},isPointedSo:function(a){return this._callback=a,this},areClickedSo:function(a){return this._callback=a,this},so:function(a){return this._callback=a,this},build:function(a){return new Cassava.Event(this._manager,a,this._update,this._init,this._name,this._callback,this._arg1,this._arg2,this._arg3)},recycle:function(a,b){return a.init(b,this._update,this._init,this._name,this._callback,this._arg1,this._arg2,this._arg3)}},Cassava.Event.Factory.create=function(a,b){if(null===this._factories.get(a))throw new Error('Event template "'+a+'" is not defined.');return 0===this._pool.length?this._factories.get(a).build(b):this._factories.get(a).recycle(this._pool.pop(),b)},Cassava.Event.Factory.EntityTileCollision=function(a,b){this.id=this._name=a,this._tiles=null,this._entities=null,this._callback=null,this._manager=b},Cassava.Sprite=function(a,b,c,d,e){this._manager=a,this._game=this._manager.game,this.id=Cassava.getId(),this._spriteSheet=null,this._name=null,this._sequences=null,this._currentSequence=null,this._currentFrameIndex=null,this._initialFrameTTL=null,this._frameTTL=null,this._isPlaying=null,this._isLooping=null,this._isVisible=null,this.x=null,this.y=null,this.z=null,this.rotation=0,this.alpha=1,this.scale=null,this.init(b,c,d,e)},Cassava.Sprite.prototype={init:function(a,b,c,d){return this._spriteSheet=b,this._name=a,this._sequences=c,this._currentSequence=null,this._currentFrameIndex=0,this._initialFrameTTL=d&&d>0?d:1,this._frameTTL=0,this._isPlaying=!0,this._isLooping=!0,this.isVisible=!0,this.x=0,this.y=0,this.z=0,this.rotation=0,this.alpha=1,this.scale=1,this},free:function(){this._manager.free(this)},loop:function(){return this._isLooping=!0,this},dontloop:function(){return this._isLooping=!1,this},play:function(){return this._isPlaying=!0,this},stop:function(){return this._isPlaying=!1,this},show:function(){return this.isVisible=!0,this},hide:function(){return this.isVisible=!1,this},update:function(){this._frameTTL>this._initialFrameTTL&&(this._frameTTL=0,this._goToNextFrame()),this._isPlaying&&this._frameTTL++},_goToNextFrame:function(){if(null!==this._currentSequence&&void 0!==this._currentSequence){if(!this._sequences||!this._sequences[this._currentSequence])throw new Error("The sequence "+this._currentSequence+" does not exist for the sprite "+this._name+" or the sequences have not been defined.");this._currentFrameIndex>=this._sequences[this._currentSequence].to?this._currentFrameIndex=this._isLooping?this._sequences[this._currentSequence].from:this._sequences[this._currentSequence].to:++this._currentFrameIndex}else this._currentFrameIndex>=this._spriteSheet._numberOfFrames-1&&this._isLooping?this._currentFrameIndex=0:++this._currentFrameIndex}},Object.defineProperties(Cassava.Sprite.prototype,{frame:{get:function(){return this._currentFrameIndex},set:function(a){this._currentFrameIndex=a,this._frameTTL=0}},frameTTL:{get:function(){return this._frameTTL},set:function(a){this._initialFrameTTL=a}},cachedFrame:{get:function(){return this._spriteSheet.frame(this._currentFrameIndex)}},sequence:{get:function(){return this._currentSequence},set:function(a){if(this._currentSequence=a,!this._sequences||!this._sequences[this._currentSequence])throw new Error("The sequence "+this._currentSequence+" does not exist for the sprite "+this._name+" or the sequences have not been defined.");this._currentFrameIndex=this._sequences[this._currentSequence].from}}}),Cassava.Sprite.Factory=function(a,b){this._name=a,this.id=this._name,this._manager=b,this._asset=null,this._assetName=null,this._width=null,this._height=null,this._sequences=null,this._frameTTL=null,this.spriteSheetCache=null},Cassava.Sprite.Factory.create=function(a){if(null===this._factories.get(a))throw new Error('Sprite template "'+a+'" is not defined.');if(null===this.spriteSheetCache)throw new Error('The spritesheet for "'+a+'" sprite template has not been builded.');return 0===this._pool.length?this._factories.get(a).build():this._factories.get(a).recycle(this._pool.pop())},Cassava.Sprite.Factory.prototype={buildSpriteSheet:function(a){if(this._asset=a[this._assetName],!this._asset)throw new Error("Asset "+this._assetName+" has not been loaded.");this.spriteSheetCache=new Cassava.SpriteSheetCache(this._asset,this._width,this._height)},asset:function(a){return this._assetName=a,this},dimensions:function(a,b){return this._width=a,this._height=b,this},sequences:function(a){return this._sequences=a,this},frameTTL:function(a){return this._frameTTL=a,this},build:function(){return new Cassava.Sprite(this._manager,this._name,this.spriteSheetCache,this._sequences,this._frameTTL)},recycle:function(a){return a.init(this._name,this.spriteSheetCache,this._sequences,this._frameTTL)}},Cassava.AudioManager=function(a){this._game=a,this._context=null,this._initContext(),this._isDecoding=!1,this._decodingBufferBinaries=[],this._decodingBufferNames=[],this._soundsBuffer={},this._channels={}},Cassava.AudioManager.prototype={decode:function(a,b,c,d){var e;this._context&&(this._isDecoding?(this._decodingBufferBinaries.push(b),this._decodingBufferNames.push(a)):(this._isDecoding=!0,e=this,this._context.decodeAudioData(b,function(b){e._isDecoding=!1,e._soundsBuffer[a]=b,e._decodingBufferBinaries.length>0&&e.decode(e._decodingBufferNames.pop(),e._decodingBufferBinaries.pop(),c,d),c(e._soundsBuffer[a])},d)))},_initContext:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?this._context=new window.AudioContext:console.warn(":( Web Audio API is not supported on your browser... It's sad.")},addChannel:function(a){return this._channels[a]=this._context?new Cassava.AudioChannel(a,this._soundsBuffer,this._context):Cassava.AudioChannel.Invalid,this},channel:function(a){return this._channels[a]}},Cassava.AudioChannel=function(a,b,c){var d=this;this._name=a,this.id=this._name,this._currentSound=null,this._soundsLibrary=b,this._context=c,this._destination=this._context.destination,this._isStopping=!1,this._waiting={on:!1,sound:null,loop:!1},this._onEnded=function(){d._currentSound.disconnect(),d._currentSound=null,d._isStopping&&(d._isStopping=!1,d._waiting.on&&(d.play(d._waiting.sound,0,d._waiting.loop),d._waitingSound=null))}},Cassava.AudioChannel.prototype={play:function(a,b,c){return this._currentSound&&!this._isStopping?this:this._isStopping?(this._waiting.sound=a,this._waiting.on=!0,this):(this._resetWaiting(),this._currentSound=this._context.createBufferSource(),this._currentSound.buffer=this._soundsLibrary[a],this._currentSound.buffer&&(this._currentSound.onended=this._onEnded,this._currentSound.connect(this._destination),this._currentSound.start(b||0),this._currentSound.loop=c||!1),this)},stop:function(){return this._currentSound&&(this._isStopping=!0,this._currentSound.stop()),this},loop:function(){return this._currentSound&&(this._isStopping?this._waiting.loop=!0:this._currentSound.loop=!0),this},_resetWaiting:function(){this._waiting.on=!1,this._waiting.sound=null,this._waiting.loop=!1}},Cassava.AudioChannel.Invalid={play:function(){return this},stop:function(){return this},loop:function(){return this}},Cassava.Pointer=function(a,b){var c=this;this.isPointing=!1,this.game=b,this._scale=this.game.scale,this.position=new Cassava.Hitbox.Point(null),Cassava.isMobile()?(a.addEventListener("touchstart",function(a){c.isPointing=!0,c.position.x=~~((a.changedTouches[0].pageX+(c.game.camera?c.game.camera.x:0))/c._scale),c.position.y=~~((a.changedTouches[0].pageY+(c.game.camera?c.game.camera.y:0))/c._scale)}),a.addEventListener("touchend",function(){c.isPointing=!1})):(a.addEventListener("mousemove",function(a){c.position.x=~~((a.offsetX+(c.game.camera?c.game.camera.x:0))/c._scale),c.position.y=~~((a.offsetY+(c.game.camera?c.game.camera.y:0))/c._scale)}),a.addEventListener("mousedown",function(){c.isPointing=!0}),a.addEventListener("mouseup",function(){c.isPointing=!1}))},Cassava.Pointer.prototype={update:function(){this.isPointing=!1}};